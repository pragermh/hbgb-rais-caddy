<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Herbarium GB Image Viewer</title>

  <!-- OpenSeadragon -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/openseadragon.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: #000;
      color: #4CAF50;
      font-family: 'Roboto', sans-serif;
      margin: 2rem;
      line-height: 1.5;
      text-align: center;
    }
    h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    #subTitle { font-size: 1.5rem; color: #ccc; }
    #openseadragon {
      width: 90vw;
      height: 70vh;
      margin: 1rem auto;
      border: 2px solid #4CAF50;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.7);
    }
    .dl-bar {
      display: flex;
      gap: .75rem;
      justify-content: center;
      align-items: center;
      margin: 0 auto 2rem;
      flex-wrap: wrap;
      max-width: 90vw;
    }
    .btn {
      display: inline-block;
      padding: .65rem 1rem;
      border: 2px solid #4CAF50;
      color: #4CAF50;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: transform .05s ease, background-color .2s ease, color .2s ease;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .btn:hover { background-color: #4CAF50; color: #000; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    footer { margin-top: 3rem; font-size: .9rem; color: #777; font-style: italic; }
  </style>
</head>
<body>

  <h1 id="pageTitle">
    Herbarium GB Image Viewer<br>
    <span id="subTitle"></span>
  </h1>

  <div id="openseadragon"></div>

  <!-- Download buttons -->
  <div class="dl-bar" id="dlBar" style="display:none;">
    <button id="dlSmall" class="btn">⬇ Small JPEG</button>
    <button id="dlFull"  class="btn">⬇ Large JPEG</button>
  </div>

  <footer>
    &copy; 2025 Herbarium GB
  </footer>

  <script>
    // ----- Shorthands / constants -----
    const $ = id => document.getElementById(id);
    const IIIF_ROOT = '/iiif';
    const SHARD_PREFIX_LEN = 7;

    // ----- ID parsing & validation -----
    const pathId = location.pathname.replace(/^\/+|\/+$/g, ''); // no default
    const hasId = !!pathId;
    const isValidGbId = id => /^GB-\d{7}$/.test(id);

    // ----- UI helpers -----
    const setSubtitle = text => { $('subTitle').textContent = text; };
    const clearViewer = () => { $('openseadragon').replaceChildren(); $('dlBar').style.display = 'none'; };
    const showNoId = () => { setSubtitle('No QR code ID given'); clearViewer(); };
    const showGenericNotFound = () => { setSubtitle('Requested QR code ID not found'); clearViewer(); };
    const showIdNotFound = id => { setSubtitle(`${id} not found`); clearViewer(); };
    const showOk = id => { setSubtitle(id); };

    // ----- Network helpers -----
    async function headOk(url, timeout = 6000) {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), timeout);
      try {
        const r = await fetch(url, { method: 'HEAD', signal: ctrl.signal, cache: 'no-store' });
        return r.ok;
      } catch { return false; }
      finally { clearTimeout(timer); }
    }

    async function downloadViaBlob(url, filename) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error(`Download failed: ${r.status}`);
        const blob = await r.blob();
        const u = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = u; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(u);
      } catch (e) {
        console.error('Download error', e);
        alert('Download failed. Please try again.');
      }
    }

    // ----- Flow -----
    if (!hasId) {
      showNoId();
    } else if (!isValidGbId(pathId)) {
      showGenericNotFound();
    } else {
      const imageId = pathId;
      showOk(imageId);

      (async () => {
        try {
          // index lookup
          const shard = imageId.slice(0, SHARD_PREFIX_LEN);
          const idxUrl = `/idx/${shard}.json`;
          const resp = await fetch(idxUrl, { cache: 'force-cache' });
          if (!resp.ok) throw new Error('Index missing');

          const map = await resp.json();
          const rel = map[imageId];
          if (!rel) { showIdNotFound(imageId); return; }

          const jp2Base = `${IIIF_ROOT}/${rel}/${imageId}.jp2`;
          const infoUrl = `${jp2Base}/info.json`;
          if (!(await headOk(infoUrl))) { showIdNotFound(imageId); return; }

          // viewer
          OpenSeadragon({
            id: 'openseadragon',
            prefixUrl: 'https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/images/',
            showNavigator: true,
            navigatorPosition: 'BOTTOM_RIGHT',
            crossOriginPolicy: 'Anonymous',
            tileSources: infoUrl
          }).addHandler('open-failed', () => { showIdNotFound(imageId); });

          // downloads
          const smallUrl = `${jp2Base}/full/1200,/0/default.jpg`;
          const fullUrl  = `${jp2Base}/full/full/0/default.jpg`;
          $('dlSmall').onclick = () => downloadViaBlob(smallUrl, `${imageId}-small.jpg`);
          $('dlFull').onclick  = () => downloadViaBlob(fullUrl,  `${imageId}-large.jpg`);
          $('dlBar').style.display = 'flex';
        } catch {
          showIdNotFound(pathId); // valid format, but something failed
        }
      })();
    }
  </script>

</body>
</html>
